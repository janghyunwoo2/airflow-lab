# 5\. í•µì‹¬ Operator ì‹¤ìŠµ (Airflow 3.x, Logging ê¸°ë°˜)

## ğŸ¯ ëª©í‘œ

- Airflowì—ì„œ ì‚¬ìš©í•˜ëŠ” ëŒ€í‘œì ì¸ operator ì— ëŒ€í•´ì„œ ì´í•´í•œë‹¤.
- operatorê°€ í¬í•¨ëœ ì½”ë“œë¥¼ ì‘ì„±í•´ë³¸ë‹¤.

* * *

## ğŸ§© Airflow ë¡œê·¸ ì¶œë ¥ ë°©ì‹

Airflowì—ì„œëŠ” ë‹¨ìˆœ `print()` ëŒ€ì‹  **Airflow Logger ì‚¬ìš©**ì„ ê¶Œì¥í•œë‹¤.

```python
from airflow.utils.log.logging_mixin import LoggingMixin

log = LoggingMixin().log
log.info("this is airflow log")
```

- Task Logì— êµ¬ì¡°ì ìœ¼ë¡œ ê¸°ë¡ë¨
- ë¡œê·¸ ë ˆë²¨(`info`, `warning`, `error`) ì‚¬ìš© ê°€ëŠ¥
- ìš´ì˜ í™˜ê²½ ë¡œê·¸ ìˆ˜ì§‘ì— ì í•©

* * *

## 5-1. BashOperator

### Operator ì„¤ëª…

- **ì™¸ë¶€ ì‰˜ ëª…ë ¹ì„ ì‹¤í–‰**í•˜ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ Operator
- stdout / stderrê°€ ê·¸ëŒ€ë¡œ Airflow Task Logì— ê¸°ë¡ë¨
- ì‹¤íŒ¨ ì—¬ë¶€ëŠ” **exit code**ë¡œ íŒë‹¨

### ì‹¤ìŠµ ì½”ë“œ

**íŒŒì¼ëª…: `dags/05_bash_operator.py`**

```python
from airflow.decorators import dag
from airflow.operators.bash import BashOperator
from airflow.operators.empty import EmptyOperator
from datetime import datetime

@dag(
    dag_id="op_bash_operator_demo",
    start_date=datetime(2024, 1, 1),
    schedule=None,
    catchup=False,
    tags=["example", "tutorial"],
)
def bash_operator_demo():
    start = EmptyOperator(task_id="start")

    echo = BashOperator(
        task_id="echo",
        bash_command="echo '[INFO] Hello from BashOperator'",
    )

    fail = BashOperator(
        task_id="intentional_fail",
        bash_command="echo '[ERROR] about to fail' && exit 1",
    )

    end = EmptyOperator(task_id="end")

    start >> echo >> fail >> end

bash_operator_demo()
```

* * *

## 5-2. TaskFlow API (`@task`)

### Operator ì„¤ëª…

- Airflow 2.x ì´í›„ **ê¶Œì¥ë˜ëŠ” Python Task ì‘ì„± ë°©ì‹**
- Python í•¨ìˆ˜ = Task
- ë°˜í™˜ê°’ì´ ìë™ìœ¼ë¡œ XComì— ì €ì¥ë˜ì–´ **ë°ì´í„° íë¦„ í‘œí˜„ì´ ê°„ê²°**

### ì‹¤ìŠµ ì½”ë“œ

**íŒŒì¼ëª…: `dags/05_taskflow_logging.py`**

```python
from airflow.decorators import dag, task
from airflow.utils.log.logging_mixin import LoggingMixin
from datetime import datetime

log = LoggingMixin().log

@dag(
    dag_id="op_taskflow_logging_demo",
    start_date=datetime(2024, 1, 1),
    schedule=None,
    catchup=False,
    tags=["example", "tutorial"],
)
def taskflow_logging_demo():

    @task
    def extract():
        log.info("Extracting raw data")
        return "raw-data"

    @task
    def transform(data: str):
        log.info("Transforming data: %s", data)
        return data.upper()

    @task
    def load(result: str):
        log.info("Loading result: %s", result)

    raw = extract()
    processed = transform(raw)
    load(processed)

taskflow_logging_demo()
```

* * *

## 5-3. PythonOperator

### Operator ì„¤ëª…

- í´ë˜ì‹í•œ Python ì‹¤í–‰ Operator
- ì‹¤í–‰ ì‹œì ì˜ **contextë¥¼ ì§ì ‘ ì œì–´**í•  ìˆ˜ ìˆìŒ
- TaskFlow API ì´ì „ ì½”ë“œë‚˜ ëª…ì‹œì  ì œì–´ê°€ í•„ìš”í•œ ê²½ìš°ì— ì‚¬ìš©

### ì‹¤ìŠµ ì½”ë“œ

**íŒŒì¼ëª…: `dags/05_python_operator_logging.py`**

```python
from airflow.decorators import dag
from airflow.operators.python import PythonOperator
from airflow.utils.log.logging_mixin import LoggingMixin
from datetime import datetime

log = LoggingMixin().log

def print_context(**context):
    log.info("dag_id=%s", context["dag"].dag_id)
    log.info("task_id=%s", context["task"].task_id)
    log.info("run_id=%s", context["run_id"])
    log.info("logical_date=%s", context["logical_date"])

@dag(
    dag_id="op_python_operator_logging_demo",
    start_date=datetime(2024, 1, 1),
    schedule=None,
    catchup=False,
    tags=["example", "tutorial"],
)
def python_operator_logging_demo():

    PythonOperator(
        task_id="print_context",
        python_callable=print_context,
    )

python_operator_logging_demo()
```

* * *

## 5-4. BranchPythonOperator

### Operator ì„¤ëª…

- ì¡°ê±´ì— ë”°ë¼ **ì‹¤í–‰ ê²½ë¡œë¥¼ ë¶„ê¸°**í•˜ëŠ” Operator
- ì„ íƒë˜ì§€ ì•Šì€ TaskëŠ” `skipped` ìƒíƒœê°€ ë¨
- ë‚ ì§œ/ì‹œê°„/ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ê¸°ë°˜ ë¶„ê¸°ì— ìì£¼ ì‚¬ìš©

### ì‹¤ìŠµ ì½”ë“œ

**íŒŒì¼ëª…: `dags/05_branch_operator_logging.py`**

```python
from airflow.decorators import dag
from airflow.operators.python import BranchPythonOperator
from airflow.operators.bash import BashOperator
from airflow.operators.empty import EmptyOperator
from airflow.utils.log.logging_mixin import LoggingMixin
from datetime import datetime

log = LoggingMixin().log

def choose_path(**context):
    logical_date = context["logical_date"]
    weekday = logical_date.weekday()
    log.info("logical_date=%s weekday=%s", logical_date, weekday)

    if weekday < 5:
        return "weekday_task"
    return "weekend_task"

@dag(
    dag_id="op_branch_logging_demo",
    start_date=datetime(2024, 1, 1),
    schedule=None,
    catchup=False,
    tags=["example", "tutorial"],
)
def branch_logging_demo():
    start = EmptyOperator(task_id="start")

    branch = BranchPythonOperator(
        task_id="branch",
        python_callable=choose_path,
    )

    weekday = BashOperator(task_id="weekday_task", bash_command="echo 'weekday'")
    weekend = BashOperator(task_id="weekend_task", bash_command="echo 'weekend'")

    end = EmptyOperator(
        task_id="end",
        trigger_rule="none_failed_min_one_success",
    )

    start >> branch >> [weekday, weekend] >> end

branch_logging_demo()
```

* * *

## 5-5. ShortCircuitOperator

### Operator ì„¤ëª…

- ì¡°ê±´ì´ `False`ì´ë©´ **ì´í›„ ëª¨ë“  Taskë¥¼ ìŠ¤í‚µ**
- Branchì™€ ë‹¬ë¦¬ "ê²½ë¡œ ì„ íƒ"ì´ ì•„ë‹ˆë¼ "ì „ì²´ ì¤‘ë‹¨"ì— ê°€ê¹Œì›€
- ë°ì´í„°ê°€ ì—†ì„ ë•Œ íŒŒì´í”„ë¼ì¸ì„ ì¡°ê¸°ì— ë©ˆì¶”ëŠ” ë° ìœ ìš©

### ì‹¤ìŠµ ì½”ë“œ

**íŒŒì¼ëª…: `dags/05_short_circuit_logging.py`**

```python
from airflow.decorators import dag
from airflow.operators.python import ShortCircuitOperator
from airflow.operators.bash import BashOperator
from airflow.operators.empty import EmptyOperator
from airflow.utils.log.logging_mixin import LoggingMixin
from datetime import datetime

log = LoggingMixin().log

def should_run(**context):
    logical_date = context["logical_date"]
    result = (logical_date.minute % 2) == 0
    log.info("logical_date=%s should_run=%s", logical_date, result)
    return result

@dag(
    dag_id="op_short_circuit_logging_demo",
    start_date=datetime(2024, 1, 1),
    schedule=None,
    catchup=False,
    tags=["example", "tutorial"],
)
def short_circuit_logging_demo():
    start = EmptyOperator(task_id="start")

    gate = ShortCircuitOperator(
        task_id="gatekeeper",
        python_callable=should_run,
    )

    work = BashOperator(
        task_id="do_work",
        bash_command="echo 'work running'",
    )

    end = EmptyOperator(task_id="end")

    start >> gate >> work >> end

short_circuit_logging_demo()
```

* * *

## 5-6. EmptyOperator

### Operator ì„¤ëª…

- ì‹¤ì œ ë¡œì§ì€ ì—†ê³  **DAG êµ¬ì¡°ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•œ Operator**
- ë³‘ë ¬ ì²˜ë¦¬ ì‹œì‘/ì¢…ë£Œ ì§€ì , í•©ë¥˜ ì§€ì  í‘œí˜„ì— ì‚¬ìš©
- DAG ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

### ì‹¤ìŠµ ì½”ë“œ

**íŒŒì¼ëª…: `dags/05_empty_operator_structure.py`**

```python
from airflow.decorators import dag
from airflow.operators.empty import EmptyOperator
from airflow.operators.bash import BashOperator
from datetime import datetime

@dag(
    dag_id="op_empty_operator_structure_demo",
    start_date=datetime(2024, 1, 1),
    schedule=None,
    catchup=False,
    tags=["example", "tutorial"],
)
def empty_operator_structure_demo():
    start = EmptyOperator(task_id="start")

    task_a = BashOperator(task_id="task_a", bash_command="echo 'A' && sleep 2")
    task_b = BashOperator(task_id="task_b", bash_command="echo 'B' && sleep 2")

    end = EmptyOperator(task_id="end")

    start >> [task_a, task_b] >> end

empty_operator_structure_demo()
```

* * *

## Operator ì„ íƒ ìš”ì•½

- **BashOperator**: ì‰˜ ëª…ë ¹ ì‹¤í–‰
- **TaskFlow API**: Python ê¸°ë°˜ ë°ì´í„° íë¦„ ì²˜ë¦¬ (ê¶Œì¥)
- **PythonOperator**: ëª…ì‹œì  Python ì‹¤í–‰ / context ì œì–´
- **BranchPythonOperator**: ì¡°ê±´ ë¶„ê¸°
- **ShortCircuitOperator**: ì¡°ê±´ ë¶ˆë§Œì¡± ì‹œ ì „ì²´ ìŠ¤í‚µ
- **EmptyOperator**: êµ¬ì¡° ì •ë¦¬ ë° ê°€ë…ì„±

<br>